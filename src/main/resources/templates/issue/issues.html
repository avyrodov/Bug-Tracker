<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header.html :: header(title='Bug Tracker - Issues')}"></head>

<body class="d-flex flex-column h-100 color_sub_bg">
<div th:replace="~{fragments/menu.html :: menu}"></div>

<script>
    function clearFormVisible(form) {
        $(form)[0].reset();
        $('#authorIds').val(null).trigger('change');
        $('#authorCommentIds').val(null).trigger('change');
    }

    $(document).ready(function () {
        $('#authorIds').select2({
            width: '100%',
            theme: "bootstrap-5",
            searchInputPlaceholder: 'Search authors...',
            placeholder: ''
        })

        $('#authorCommentIds').select2({
            width: '100%',
            theme: "bootstrap-5",
            searchInputPlaceholder: 'Search author comments...',
            placeholder: ''
        })

        $('.trash').on('click', function (event) {
            event.preventDefault();
            let url = $(this).attr('href');
            deleteIssue(url);
        });

        function deleteIssue(url) {
            Swal.fire({
                title: '',
                text: 'Are you sure you want to delete the selected records?',
                icon: 'warning',
                showCancelButton: true
            }).then(function (result) {
                if (result.isConfirmed) {
                    showNotice('Deleting...');
                    let timer = waitingTimeExpired(30000);
                    $.ajax({
                        url: url,
                        method: 'get',
                        contentType: 'application/json',
                        statusCode: {
                            200: function (xhr) {
                                notice.hideLoading();
                                stopTimer(timer);
                                Swal.fire({
                                    title: 'Records has been deleted.',
                                    text: '',
                                    icon: 'success',
                                    showConfirmButton: false,
                                    timer: 1000
                                }).then(function () {
                                    window.location.href = '/issue/issues.html';
                                });
                            },
                            400: function (xhr) {
                                notice.hideLoading();
                                stopTimer(timer);
                                Swal.fire({
                                    title: '',
                                    text: xhr.responseText,
                                    icon: 'error',
                                });
                            },
                            500: function (xhr) {
                                notice.hideLoading();
                                stopTimer(timer);
                                Swal.fire({
                                    title: '',
                                    text: '',
                                    icon: 'error',
                                });
                            }
                        }
                    });
                } else if (result.dismiss === Swal.DismissReason.cancel) {
                    Swal.fire({
                        title: 'Cancelled',
                        text: '',
                        icon: 'error',
                        showConfirmButton: false,
                        timer: 1000
                    });
                }
            });
        }
    })
</script>

<main>
    <div class="container">
        <div class="card color_bg mb-2">
            <form th:action="@{/issue/issues.html}" th:object="${command}" method="post">
                <div class="card-header initialism" th:text="#{filter}"></div>
                <div class="card-body">
                    <div class="row mb-2">
                        <label class="col-3 col-lg-4 col-md-3 col-form-label text-md-end">
                            <span th:text="#{issue.name}"></span>:
                        </label>
                        <div class="col-9 col-lg-4 col-md-6">
                            <input type="text" class="form-control color_bg color_headline" id="name" th:field="${command.name}">
                        </div>
                    </div>
                    <div class="row mb-2">
                        <label class="col-3 col-lg-4 col-md-3 col-form-label text-md-end">
                            <span th:text="#{issue.status}"></span>:
                        </label>
                        <div class="col-9 col-lg-4 col-md-6">
                            <select th:field="${command.status}" class="form-control">
                                <option value=""></option>
                                <option th:each="value : ${T(com.avyrodov.bugTracker.entity.Status).values()}"
                                        th:value="${value.name()}"
                                        th:text="${#strings.capitalize(#strings.toLowerCase(value.name()))}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <label class="col-3 col-lg-4 col-md-3 col-form-label text-md-end">
                            <span th:text="#{issue.author}"></span>:
                        </label>
                        <div class="col-9 col-lg-4 col-md-6">
                            <select th:field="${command.authorIds}" multiple="multiple">
                                <option value=""></option>
                                <option th:each="user : ${T(com.avyrodov.bugTracker.web.utils.UserUtils).getUsers()}"
                                        th:value="${user.getUserId()}"
                                        th:text="${user.getFullname()}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <label class="col-3 col-lg-4 col-md-3 col-form-label text-md-end">
                            <span th:text="#{comment.author}"></span>:
                        </label>
                        <div class="col-9 col-lg-4 col-md-6">
                            <select th:field="${command.authorCommentIds}" multiple="multiple">
                                <option value=""></option>
                                <option th:each="user : ${T(com.avyrodov.bugTracker.web.utils.UserUtils).getUsers()}"
                                        th:value="${user.getUserId()}"
                                        th:text="${user.getFullname()}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="offset-lg-4 offset-md-3 col-12 col-lg-4 col-md-6">
                            <input class="btn btn-primary" th:value="#{button.search}" type="submit">
                            <input class="btn btn-outline-danger" th:value="#{button.clear}" type="button" onclick="clearFormVisible(this.form);">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="card">
            <div class="card-header initialism" th:text="#{issueTracker}"></div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <tbody>
                        <tr th:if="${issues.size == 0}">
                            <td class="text-center">
                                <small class="text-muted">No issue</small>
                            </td>
                        </tr>
                        <tr th:each="issue, status : ${issues}">
                            <td>
                                <a th:href="@{/issue/edit.html(issueId=${issue.issueId})}" th:text="${issue.name}"></a>
                            </td>
                            <td style="width: 120px;" th:text="${issue.status.name()}"></td>
                            <td style="width: 120px;" th:text="${#temporals.format(issue.startDate, 'MM/dd/yyyy')}"></td>
                            <td style="width: 50px;">
                                <a th:href="@{/issue/delete(issueId=${issue.issueId})}" class="trash"><i class='bx bxs-trash-alt trash'></i></a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer.html :: footer}"></footer>
</body>
</html>
